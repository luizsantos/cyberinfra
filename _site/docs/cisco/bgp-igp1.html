<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>CyberInfra</title>

  <link rel="stylesheet" href="/css/main.css">
  
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" /> <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>CyberInfra | Sistemas Operacionais, Redes de Computadores, Cibersegurança…</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="CyberInfra" />
<meta name="author" content="Luiz Arthur Feitosa dos Santos" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Sistemas Operacionais, Redes de Computadores, Cibersegurança…" />
<meta property="og:description" content="Sistemas Operacionais, Redes de Computadores, Cibersegurança…" />
<link rel="canonical" href="http://localhost:4000/docs/cisco/bgp-igp1" />
<meta property="og:url" content="http://localhost:4000/docs/cisco/bgp-igp1" />
<meta property="og:site_name" content="CyberInfra" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="CyberInfra" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Luiz Arthur Feitosa dos Santos"},"@type":"WebPage","headline":"CyberInfra","url":"http://localhost:4000/docs/cisco/bgp-igp1","description":"Sistemas Operacionais, Redes de Computadores, Cibersegurança…","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WJPJ7DKEWG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WJPJ7DKEWG');
</script>

  
<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    
    <h1>luiz@CyberInfra:~#</h1>
    </a>
    <h3>Sistemas Operacionais, Redes de Computadores, Cibersegurança...</h3>
    <div class="header-links">
      <a href="/docs"><h2 class="header-link">Documentos</h2></a>
<a href="/videos"><h2 class="header-link">Videos</h2></a>
<a href="/archive"><h2 class="header-link">Postagens</h2></a>
<a href="/about"><h2 class="header-link">Sobre</h2></a>
<!-- <a href="/atom.xml"><h2 class="header-link">RSS</h2></a> -->

    </div>
  </div>
</header>

    <div class="container">
      <section id="main_content">
        <article>
  <h1 id="ibgp">iBGP</h1>

<p>O BGP (Border Gateway Protocol), é um protocolo EGP (Exterior Gateway Protocol), ou seja, é um protocolo de roteamento dinâmico utilizado para interligar Sistemas Autônomos (AS) na Internet. No que se trata de Internet, o BGP4, é atualmente o único protocolo EGP utilizado para interconectar as redes da Internet, o que torna o BGP extremamente importante.</p>

<p>A configuração do BGP basicamente se classifica e distingue, de duas formas: eBGP (exterior Gateway Protocol) e iBGP (interior Gateway Protocol). Um eBGP, é utilizado para interligar roteadores de ASs distintos. Já o iBGP, é utilizado para interligar roteadores de um mesmo AS.</p>

<p>Anteriormente foram apresentados <a href="bgp-egp1">dois exemplos de configuração utilizando apenas eBGP</a>, a seguir será apresentado um exemplo de configuração utilizando iBGP.</p>

<h1 id="exemplo-3---configuração-ibgp-e-ebgp">Exemplo 3 - Configuração iBGP e eBGP</h1>

<p>O cenário de rede proposto aqui, é para ilustrar principalmente a configuração de uma rede BGP, com iBGP, mas é claro que para isso, também serão configurados roteadores com eBGP. Devido à isso, este cenário é uma mescla de eBGP com iBGP, além de protocolos IGP (OSPF e RIP) e EGP (BGP). Por isso esse cenário de exemplo é bem mais complexo que os cenários apresentados no <a href="bgp-egp1">Exemplo 1 e 2 apenas com eBGP</a>.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="imagens/BGP03.png" alt="rede" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">Figura 1 - Cenário de rede do Exemplo iBGP</td>
    </tr>
  </tbody>
</table>

<p>De forma geral, na rede do exemplo há quatro ASs, sendo esses:</p>
<ul>
  <li><strong>AS1</strong> - é um AS com quatro redes (LAN1, LAN2, LAN3 e LAN4), essas redes são interligadas por quatro roteadores CISCO (R1, R2, R3 e R4). Tal AS é um <em>transient</em> AS, ou seja, é uma rede que interliga outras redes, ele vai ser o <em>backbone</em> dos demais ASs desse cenário;</li>
  <li><strong>AS2</strong> - é um pequeno AS com apenas duas redes (LAN5 e LAN6), o roteamento entre essas LAN é estático, e o roteador R5, deste cenário, é ligado via eBGP com o R1 do AS1;</li>
  <li><strong>AS3</strong> - é uma rede com três roteadores (R6, R7 e R8), interligados via iBGP. O roteador R6 tem uma ligação eBGP com R3 do AS1. No AS3, há três LANs (LAN7, LAN8 e LAN9);</li>
  <li><strong>AS4</strong> - é uma rede similar ao AS3, todavia o roteamento interno desse AS é feito via IGP, no caso o OSPF. o AS4 tem uma ligação eBGP com R2 no AS1. O AS4 tem as redes LAN 10, 11 e 12.</li>
</ul>

<p>Resumindo, nesse cenário de rede temos:</p>
<ul>
  <li><strong>Três ligações eBGP</strong>: R5-&gt;R1; R6-&gt;R3; e R9-&gt;R2 - todas as ligações eBGP são representadas na Figura 1, por linhas azuis.</li>
  <li><strong>Duas redes conectadas via iBGP</strong>: AS1 e AS3, as ligações iBGP nesses ASs são representadas por linhas tracejadas.</li>
</ul>

<blockquote>
  <p>As representações e sinalizações de <em>hosts</em> e redes do cenário - IPs, etc - são feitas de forma semelhante ao que foi explicado nos <a href="bgp-egp1">Exemplos 1 e 2</a>, então na dúvida veja o texto desses exemplos primeiro.</p>
</blockquote>

<h2 id="configuração-dos-ips-nas-interfaces-de-rede">Configuração dos IPs nas interfaces de rede</h2>

<p>Como já foi descrito anteriormente, esse cenário de rede é relativamente complexo, então é extremamente importante realizar corretamente o endereçamento de <em>hosts</em> e roteadores do cenário proposto.</p>

<blockquote>
  <p>Este cenário de teste foi feito no <a href="https://gns3.com/">GNS3</a>, e os <em>hosts</em> são <a href="https://docs.gns3.com/docs/emulators/vpcs/">VPCS</a> do GNS3 - não será apresentado aqui a configuração de tais <em>hosts</em>.</p>
</blockquote>

<p>Também é importante realizar corretamente a configuração do roteamento via OSPF nos roteadores do AS4.
A configuração básica de IPs e OSPF dos roteadores podem ser vistas, <a href="bgp-ibgp1-interfaces">clicando-se aqui</a></p>

<blockquote>
  <p>Não intenção desse material explicar em detalhes as configurações de endereços IP, nem do OSPF. Há outros materiais neste sítio Web explicando como realizar tais configurações! ;-)</p>
</blockquote>

<h2 id="configuração-dos-pares-ebgp">Configuração dos pares eBGP</h2>

<p>A configuração deste cenário pode iniciar de várias formas, para vamos iniciar com a configuração das conexões eBGP entre os ASs do cenário de rede.</p>

<h3 id="ebgp-r5-r1">eBGP R5-&gt;R1</h3>

<p>Vamos iniciar conectando o AS2 ao AS1, isso é feito via eBGP do roteador R5 para o R1, sendo que a configuração do R5, fica da seguinte forma:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R5#</span>configure terminal
<span class="go">Enter configuration commands, one per line.  End with CNTL/Z.
</span><span class="gp">R5(config)#</span>router bgp 2
<span class="gp">R5(config-router)#</span>neighbor 10.2.0.101 remote-as 1
<span class="gp">R5(config-router)#</span>network 10.2.5.0 mask 255.255.255.0
<span class="gp">R5(config-router)#</span>network 10.2.6.0 mask 255.255.255.0
<span class="gp">R5(config-router)#</span><span class="w">
</span></code></pre></div></div>
<p>Na configuração anterior do R5, informamos que o seu vizinho é o R1 no AS1 (<code class="language-plaintext highlighter-rouge">neighbor 10.2.0.101 remote-as 1</code>). E informamos que serão publicadas as redes 10.2.5.0/24 e 10.2.6.0/24 com o comando <code class="language-plaintext highlighter-rouge">network</code>.</p>

<p>Já a configuração do R1, fica assim:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R1#</span>configure terminal
<span class="go">Enter configuration commands, one per line.  End with CNTL/Z.
</span><span class="gp">R1(config)#</span>router bgp 1
<span class="gp">R1(config-router)#</span>neighbor 10.2.0.105 remote-as 2
<span class="gp">R1(config-router)#</span><span class="w">
</span><span class="go">*May  9 21:47:18.099: %BGP-5-ADJCHANGE: neighbor 10.2.0.105 Up
</span></code></pre></div></div>
<p>A configuração do R1, só informa que seu vizinho eBGP é o R5, ele não tem redes para publicar. Note que no final da saída o roteador CISCO já mostra que há adjacência formada com o R2 (<code class="language-plaintext highlighter-rouge">BGP-5-ADJCHANGE: neighbor 10.2.0.105 Up</code>).</p>

<p>É possível ver se se R1 e R5 está conectados via BGP, utilizando os seguintes comandos:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R1#</span>show ip bgp summary
<span class="go">BGP router identifier 10.2.0.101, local AS number 1
BGP table version is 3, main routing table version 3
2 network entries using 264 bytes of memory
2 path entries using 104 bytes of memory
2/1 BGP path/bestpath attribute entries using 336 bytes of memory
1 BGP AS-PATH entries using 24 bytes of memory
0 BGP route-map cache entries using 0 bytes of memory
0 BGP filter-list cache entries using 0 bytes of memory
BGP using 728 total bytes of memory
BGP activity 2/0 prefixes, 2/0 paths, scan interval 60 secs

Neighbor        V          AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
10.2.0.105      4          2       7       6        3    0    0 00:04:35        2
</span></code></pre></div></div>

<p>No exemplo da saída do comando <code class="language-plaintext highlighter-rouge">show ip bgp summary</code> executado em R1, é possível ver na última linha, que R1 e R2 estão com uma conexão eBGP estabelecida, isso se mostra pela última coluna, que possui um número inteiro positivo (no caso <code class="language-plaintext highlighter-rouge">2</code>, na coluna <code class="language-plaintext highlighter-rouge">State/PfxRcd</code>).</p>

<p>Também é interessante ver as rotas para as redes de R5 foram enviadas via BGP para R1, isso pode ser feito com o comando:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R1#</span>show ip bgp
<span class="go">BGP table version is 3, local router ID is 10.2.0.101
</span><span class="gp">Status codes: s suppressed, d damped, h history, * valid, &gt;</span><span class="w"> </span>best, i - internal,
<span class="go">              r RIB-failure, S Stale
Origin codes: i - IGP, e - EGP, ? - incomplete

   Network          Next Hop            Metric LocPrf Weight Path
</span><span class="gp">*&gt;</span><span class="w"> </span>10.2.5.0/24      10.2.0.105               0             0 2 i
<span class="gp">*&gt;</span><span class="w"> </span>10.2.6.0/24      10.2.0.105               0             0 2 i
</code></pre></div></div>
<p>A saída do comando anterior, mostra que R1 sabe chegar na LAN5 (10.2.5.0/24) e LAN6 (10.2.6.0/24), via R5 (10.2.0.105), passando pelo AS2 (<code class="language-plaintext highlighter-rouge">2 i</code>).</p>

<blockquote>
  <p><strong>Atenção</strong>: É recomendável repetir esses comandos em todas as conexões BGP formadas, para ter certeza que tudo está correndo conforme o esperado. Todavia para o texto não ficar muito repetitivo, só vamos repetir esses comandos em momentos oportunos - que sabemos que vão haver problemas! :-p</p>
</blockquote>

<h3 id="ebgp-r9-r2">eBGP R9-&gt;R2</h3>

<p>Agora vamos configurar o eBGP entre AS4 e AS1, isso deve ser feito nos roteadores da seguinte forma:</p>
<ul>
  <li>Roteador R9:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R9#</span>configure terminal
<span class="go">Enter configuration commands, one per line.  End with CNTL/Z.
</span><span class="gp">R9(config)#</span>router bgp 4
<span class="gp">R9(config-router)#</span>neighbor 192.168.0.102 remote-as 1
<span class="gp">R9(config-router)#</span>network 192.168.10.0 mask 255.255.255.0
<span class="gp">R9(config-router)#</span>network 192.168.11.0 mask 255.255.255.0
<span class="gp">R9(config-router)#</span>network 192.168.12.0 mask 255.255.255.0
<span class="gp">R9(config-router)#</span>end
</code></pre></div>    </div>
    <p>Na configuração anterior, em R9 criamos a vinhança de R9 e R2 via eBGP (<code class="language-plaintext highlighter-rouge">neighbor 192.168.0.102 remote-as 1</code>), depois pedimos para que R9 publique as redes LAN10, LAN11 e LAN12</p>
  </li>
  <li>Roteador R2:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R2#</span>configure terminal
<span class="go">Enter configuration commands, one per line.  End with CNTL/Z.
</span><span class="gp">R2(config)#</span>router bgp 1
<span class="gp">R2(config-router)#</span>neighbor 192.168.0.109 remote-as 4
<span class="go">*May  9 22:01:38.383: %BGP-5-ADJCHANGE: neighbor 192.168.0.109 Up
</span><span class="gp">R2(config-router)#</span>network 10.1.3.0 mask 255.255.255.0
<span class="gp">R2(config-router)#</span>network 10.1.4.0 mask 255.255.255.0
</code></pre></div>    </div>
    <p>Na configuração de R2, criamos a vizinhança entre R2 e R9, depois publicamos as redes LAN3 e LAN3. Para ver se tudo funcionou vamos executar o comando <code class="language-plaintext highlighter-rouge">show ip bgp</code> em R2:</p>
  </li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R2#</span>show ip bgp
<span class="go">BGP table version is 6, local router ID is 192.168.0.102
</span><span class="gp">Status codes: s suppressed, d damped, h history, * valid, &gt;</span><span class="w"> </span>best, i - internal,
<span class="go">              r RIB-failure, S Stale
Origin codes: i - IGP, e - EGP, ? - incomplete

   Network          Next Hop            Metric LocPrf Weight Path
</span><span class="gp">*&gt;</span><span class="w"> </span>10.1.3.0/24      0.0.0.0                  0         32768 i
<span class="gp">*&gt;</span><span class="w"> </span>10.1.4.0/24      0.0.0.0                  0         32768 i
<span class="gp">*&gt;</span><span class="w"> </span>192.168.10.0     192.168.0.109            2             0 4 i
<span class="gp">*&gt;</span><span class="w"> </span>192.168.11.0     192.168.0.109            2             0 4 i
<span class="gp">*&gt;</span><span class="w"> </span>192.168.12.0     192.168.0.109            2             0 4 i
</code></pre></div></div>

<p>Perceba que todas as redes declaradas em R9 e R2 estão na tabela de roteamento de R2, o que representa sucesso em nossa configuração! Isso significa que os <em>hosts</em> conectados ao R2 podem trocar informações aos hosts conectados ao AS4, então vamos fazer esse teste:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">PC4&gt;</span><span class="w"> </span>ping 10.1.3.1 <span class="nt">-c</span> 1
<span class="go">
84 bytes from 10.1.3.1 icmp_seq=1 ttl=63 time=19.436 ms

</span><span class="gp">PC4&gt;</span><span class="w"> </span>ping 192.168.10.1 <span class="nt">-c</span> 1
<span class="go">
192.168.10.1 icmp_seq=1 timeout

</span><span class="gp">PC4&gt;</span><span class="w"> </span>ping 192.168.11.1 <span class="nt">-c</span> 1
<span class="go">
192.168.11.1 icmp_seq=1 timeout

</span><span class="gp">PC4&gt;</span><span class="w"> </span>ping 192.168.12.1 <span class="nt">-c</span> 1
<span class="go">
192.168.12.1 icmp_seq=1 timeout
</span></code></pre></div></div>
<p><strong>Atenção</strong>, pela saída do <code class="language-plaintext highlighter-rouge">ping</code> executado de PC4 para PC3 (<code class="language-plaintext highlighter-rouge">ping 10.1.3.1</code>), tudo está correto (esses fazem parte do mesmo AS no mesmo roteador). Entretanto ao tentar pingar os <em>hosts</em> que estão no AS4 (PC10, PC11 e PC12, veja que não foi possível (por exemplo no PC12 a saída foi: <code class="language-plaintext highlighter-rouge">192.168.12.1 icmp_seq=1 timeout</code>).</p>

<p>O problema relatado anteriormente ocorre, pois somente R9 sabe a rota para as rede conectadas ao R2, os demais roteadores deste AS não sabem (R10 e R11), veja as rotas conhecidas pelo R10:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R10#</span>show ip route
<span class="go">Codes: C - connected, S - static, R - RIP, M - mobile, B - BGP
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2
       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, * - candidate default, U - per-user static route
       o - ODR, P - periodic downloaded static route

Gateway of last resort is not set

O    192.168.12.0/24 [110/2] via 192.168.3.111, 02:59:18, GigabitEthernet2/0
C    192.168.10.0/24 is directly connected, FastEthernet0/0
O    192.168.11.0/24 [110/2] via 192.168.3.111, 02:59:18, GigabitEthernet2/0
O    192.168.0.0/24 [110/2] via 192.168.1.109, 03:00:41, GigabitEthernet1/0
C    192.168.1.0/24 is directly connected, GigabitEthernet1/0
O    192.168.2.0/24 [110/2] via 192.168.3.111, 02:59:18, GigabitEthernet2/0
                    [110/2] via 192.168.1.109, 03:00:41, GigabitEthernet1/0
C    192.168.3.0/24 is directly connected, GigabitEthernet2/0
</span></code></pre></div></div>
<p>Note na saída anterior, que não há nenhuma rota para as redes LAN3 e LAN3.</p>

<p>Uma possível resolução deste problema é dizer para R9 que seu roteador padrão é R2, e depois publicar via OSPF que o R9 é o roteador padrão do AS4 para os demais roteadores, então neste caso vamos fazer isso em R9:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R9#</span>configure terminal
<span class="go">Enter configuration commands, one per line.  End with CNTL/Z.
</span><span class="gp">R9(config)#</span>ip route 0.0.0.0 0.0.0.0 192.168.0.102
<span class="gp">R9(config)#</span>router ospf 1
<span class="gp">R9(config-router)#</span>default-information originate
</code></pre></div></div>
<blockquote>
  <p>Observação: daria para resolve o problema anterior via (i) roteamento estático ou (ii) iBGP, esse último será utilizando no AS3 e o primeiro foi utilizado no AS2.</p>
</blockquote>

<p>Feito isso, vamos conferir se a rota padrão foi parar, por exemplo, no R10:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R10#</span>show ip route
<span class="c">...
</span><span class="go">Gateway of last resort is 192.168.1.109 to network 0.0.0.0

O    192.168.12.0/24 [110/2] via 192.168.3.111, 03:02:52, GigabitEthernet2/0
C    192.168.10.0/24 is directly connected, FastEthernet0/0
O    192.168.11.0/24 [110/2] via 192.168.3.111, 03:02:52, GigabitEthernet2/0
O    192.168.0.0/24 [110/2] via 192.168.1.109, 03:04:15, GigabitEthernet1/0
C    192.168.1.0/24 is directly connected, GigabitEthernet1/0
O    192.168.2.0/24 [110/2] via 192.168.3.111, 03:02:52, GigabitEthernet2/0
                    [110/2] via 192.168.1.109, 03:04:15, GigabitEthernet1/0
C    192.168.3.0/24 is directly connected, GigabitEthernet2/0
O*E2 0.0.0.0/0 [110/1] via 192.168.1.109, 00:00:21, GigabitEthernet1/0
</span></code></pre></div></div>
<p>Note a linha <code class="language-plaintext highlighter-rouge">O*E2 0.0.0.0/0 [110/1] via 192.168.1.109...</code> isso indica que agora R10 tem como roteador padrão o R9. Logo vamos voltar ao teste se PC4 acessa os <em>hosts</em> do AS4:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">PC4&gt;</span><span class="w"> </span>ping 192.168.10.1 <span class="nt">-c</span> 1
<span class="go">
84 bytes from 192.168.10.1 icmp_seq=1 ttl=61 time=60.435 ms

</span><span class="gp">PC4&gt;</span><span class="w"> </span>ping 192.168.11.1 <span class="nt">-c</span> 1
<span class="go">
84 bytes from 192.168.11.1 icmp_seq=1 ttl=61 time=70.490 ms

</span><span class="gp">PC4&gt;</span><span class="w"> </span>ping 192.168.12.1 <span class="nt">-c</span> 1
<span class="go">
84 bytes from 192.168.12.1 icmp_seq=1 ttl=61 time=51.955 ms
</span></code></pre></div></div>
<p>Agora sim, a saída do teste de PC4 para PC10, 11 e 12, mostra que essa parte da rede está totalmente conexa! ;-)</p>

<p>Todavia, ainda não há conexão plena entre o AS2, AS1 e AS4, vamos resolver isso daqui a pouco…</p>

<h3 id="ebgp-r6-r3">eBGP R6-&gt;R3</h3>

<p>Neste ponto, iremos conectar as redes de R3 do AS1 R6 no AS3 via eBGP, essa será a última conexão eBGP, vamos lá, com as seguintes configurações em cada roteador CISCO:</p>
<ul>
  <li>Roteador R3:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R3#</span>configure terminal
<span class="gp">R3(config)#</span>router bgp 1
<span class="gp">R3(config-router)#</span>neighbor 172.16.0.106 remote-as 3
<span class="gp">R3(config-router)#</span>network 10.1.1.0 mask 255.255.255.0
<span class="gp">R3(config-router)#</span>network 10.1.2.0 mask 255.255.255.0
</code></pre></div>    </div>
    <p>Em R3, configuramos a conexão eBGP entre os vizinhos R3 e R6, e depois publicamos as LANs 1 e 2.</p>
  </li>
  <li>Roteador R6:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R6(config)#</span>router bgp 3
<span class="gp">R6(config-router)#</span>neighbor 172.16.0.103 remote-as 1
<span class="gp">R6(config-router)#</span><span class="w">
</span><span class="go">*May  9 23:17:59.814: %BGP-5-ADJCHANGE: neighbor 172.16.0.103 Up
</span></code></pre></div>    </div>
    <p>Em R6, só configuramos a vizinhança eBGP com R3 - a saída já mostra que a adjacência entre os vizinhos foi obtida com sucesso.</p>
  </li>
</ul>

<p>Realizadas as configurações vamos ver as redes que temos em R6:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R6#</span>show ip bgp
<span class="go">BGP table version is 3, local router ID is 172.16.2.106
</span><span class="gp">Status codes: s suppressed, d damped, h history, * valid, &gt;</span><span class="w"> </span>best, i - internal,
<span class="go">              r RIB-failure, S Stale
Origin codes: i - IGP, e - EGP, ? - incomplete

   Network          Next Hop            Metric LocPrf Weight Path
</span><span class="gp">*&gt;</span><span class="w"> </span>10.1.1.0/24      172.16.0.103             0             0 1 i
<span class="gp">*&gt;</span><span class="w"> </span>10.1.2.0/24      172.16.0.103             0             0 1 i
</code></pre></div></div>
<p>A saída do comando <code class="language-plaintext highlighter-rouge">show ip bgp</code> em R6, mostra que R6 possui rotas para as redes publicadas via BGP de R2, ou seja, a configuração feita via eBGP funcionaram.</p>

<p>TODAVIA, note que não há nenhuma rota para as redes de dentro do próprio AS3. Bem, no AS4, quem estava publicando as redes de dentro do próprio AS era o OSPF, que é um protocolo IGP. Já no AS3, vamos utilizar o iBGP para realizar a mesma tarefa.</p>

<h2 id="configuração-dos-pares-ibgp">Configuração dos pares iBGP</h2>

<p>Até aqui só havíamos configurado o BGP via eBGP, mas agora vamos utilizar o iBGP. A primeira coisa a se notar, é que o eBGP é utilizado para conectar roteadores de ASs distintos/diferentes. Já o iBGP é utilizado para conectar roteadores de um mesmo AS.</p>

<p>Assim, o iBGP vai fazer basicamente o mesmo trabalho que fez o OSPF no AS4, mas com uma grande diferença: O OSPF, no AS4, só propagou e informou a respeito de redes que estavam dentro do AS4, mas quando utilizamos o iBGP no AS3, esse pode compartilhar informações a respeito de todas as redes descobertas via BGP. Ou seja, ao configurar o iBGP no AS3, as tabelas de roteamento dos roteadores com iBGP, terão informações a respeito de todas as redes do cenário do exemplo, e é muito importante perceber que isso pode trazer vantagens e desvantagens (por exemplo tabelas de roteamento provavelmente maiores - mais custosas e processar).</p>

<p><strong>Atenção</strong>, outro ponto importante a ser notado é que o eBGP usa o campo AS_PATH para evitar <em>loops</em>, assim os <strong>roteadores BGP descartam rotas que tenham o próprio AS na lista de caminhos para as rotas recebidas</strong>.</p>

<p>Já o iBGP usa uma abordagem diferente, ele utiliza a regra de <strong>horizonte dividido</strong> (<em>split-horizon</em> - similar ao RIP). Desta forma o <strong>iBGP não repassa para outro par iBGP as rotas aprendidas com um roteador iBGP</strong>.</p>

<p>Devido a essa peculiaridade do iBGP, em não anunciar rotas aprendidas para outros roteadores iBGP, se faz necessário utilizar uma das três técnicas a seguir:</p>
<ul>
  <li><strong>Topologia Full Mesh</strong>: Nesta é necessário estabelecer uma conexão iBGP com todos os roteadores iBGP da rede em questão. Ou seja se tivermos <em>n</em> roteadores, serão necessárias <em>n</em>.(<em>n</em>-1)/2 conexões iBGP para conectar todos os pares iBGP do AS. Em um exemplo de uma rede com 10 roteadores serão necessárias 45 conexões para fechar uma rede <em>Full Mesh</em> - muito né?</li>
  <li><strong>Route Reflector</strong>: um roteador é designado para refletir as rotas aprendidas para os outros roteadores da rede, via iBGP. Esse roteador leva o nome de <em>route reflector</em>, ou seja, ele reflete para os outros roteadores, as redes descobertas. Neste cenário todos os roteadores devem ter apenas uma conexão com o roteador refletor (não precisam de conexões com os demais roteadores do AS via iBGP). Assim, para <em>n</em> roteadores teremos <em>n</em>-1 conexões iBGP, ou seja, em uma rede com 10 roteadores teremos 9 conexões BGP. Entretanto, se o roteador responsável pela reflexão “cair”, a rede inteira pode ficar indisponível - para evitar isso dá para utilizar <em>clusters</em> BGP.</li>
  <li><strong>BGP Confederation</strong>: Tal técnica, reduz o número de pares iBGP do AS, dividindo o AS em “subASes” (sub sistemas autônomos) e os agrupando em uma única confederação.</li>
</ul>

<p>É possível criar uma conexão iBGP sem nenhuma das técnicas citadas anteriormente, é claro que isso pode dar certo ou errado, principalmente em casos de mudanças na rede (falhas, alterações nos <em>links</em>, etc). É importante notar que a resolução dos problemas no BGP fica por conta do administrador de rede, assim esse deve conhecer o protocolo, a rede e tentar prever tudo o que pode acontecer. :-p</p>

<h3 id="configurando-ibgp-no-as-3">Configurando iBGP no AS 3</h3>

<p>Podemos iniciar a configuração iBGP, estabelecendo vizinhança entre todos os roteadores do AS3, no caso R6, R7 e R8. Assim, os comandos em R6 seriam:</p>

<blockquote>
  <p>Não execute esses comandos ainda…</p>
</blockquote>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R6#</span>configure terminal
<span class="gp">R6(config)#</span>router bgp 3
<span class="gp">R6(config-router)#</span>neighbor 172.16.2.107 remote-as 3
<span class="gp">R6(config-router)#</span>neighbor 172.16.1.108 remote-as 3
</code></pre></div></div>

<p>Observe só, dados os comandos anterior, estamos criando vizinhanças iBGP do R6, sendo essas:</p>
<ul>
  <li>R6-&gt;R7;</li>
  <li>R6-&gt;R8.</li>
</ul>

<p>Depois de fazer isso no R6, devemos executar comandos que estabeleçam vizinhança do R7, sendo:</p>
<ul>
  <li>R7-&gt;R6;</li>
  <li>R7-&gt;R8.</li>
</ul>

<p>Bem como do R8:</p>
<ul>
  <li>R8-&gt;R6;</li>
  <li>R8-&gt;R7.</li>
</ul>

<p>Ou seja, para criar uma rede <em>Full Mesh</em>, a formula é (3*(3-1))/2, só que para criar, por exemplo, a vizinhança entre R6-&gt;R7 é preciso executar o comando anterior <code class="language-plaintext highlighter-rouge">neighbor 172.16.1.108 remote-as 3</code>, em R7. Bem como executar o comando <code class="language-plaintext highlighter-rouge">neighbor 172.16.1.106 remote-as 3</code> em R6 para criar o par, ou seja, o número de comandos é dobrado!</p>

<p>Pior, no exemplo dado anteriormente, criando a vizinhança entre R6-&gt;R7, escolhemos utilizar o IP 172.16.1.108, para chegar em R8, e 172.16.1.106 para chegar em R6 (linha amarela na Figura 2), mas e se essa rede 172.16.1.0/24 falhar - o cabo quebrar?</p>

<p>Neste caso, é bem provável que iremos perder a vizinhança/conexão entre R6 e R8. Todavia, perceba que pela configuração de rede do exemplo, ainda haveria uma rota para R6 chegar em R8, que seria passando por R7 (linha vermelha da Figura 2). Então, para que essa falha não ocorra, podemos configurar como vizinhos R6 indo para R8 com o IP 172.16.3.108, e também, R8 indo para R6 por 172.16.2.106. Todavia, se fizemos essa redundância, o número de “vizinhos” vai dobrar e a quantidade de comandos necessário para os pares vai quadruplicar! Sem falar que ainda será necessário roteamento estático ou dinâmico via IGP (OSPF e RIP) para fazer os roteadores conhecerem todas as redes do cenário… :-p</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="imagens/BGP03-AS3.png" alt="rede" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">Figura 2 - Possibilidades de IPs para criar vizinhança do R6-R8 no iBGP do AS3</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>É preciso perceber que na prática, principalmente em roteadores CISCO - mas isso pode acontecer em outros também - quando o <em>link</em> de uma dada placa de rede falha, a placa para de responder por aquele IP - ou seja, é como se a placa fosse desligada e o IP fica indisponível.</p>
</blockquote>

<h3 id="interface-de-loopback-no-bgp">Interface de <em>loopback</em> no BGP</h3>

<p>Dado o problema citado anteriormente, uma boa prática é configurar um IP roteável em uma interface de <em>loopback</em>. Assim, essa interface virtual vai responder por todas/qualquer interface de rede física do roteador. Desta forma, não precisamos quadruplicar os comandos digitados para estabelecer os vizinhos iBGP - é claro que ainda teremos que colocar essas em rotas para que os roteadores saibam como chegar nesses IPs atrelados às interfaces de <em>loopback</em>.</p>

<p>Dadas as explicações anteriores vamos configurar o iBGP do AS3 utilizando uma rede <em>Full Mesh</em>, interface de <em>loopback</em> e o RIP para propagar as rotas internas e o IP de loopback do AS3:</p>

<ul>
  <li>Roteador R6:</li>
</ul>

<p>Para o R6, vamos inciar configurando um <strong>IP para a interface de <em>loopback</em></strong> da seguinte forma:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R6(config)#</span>int lo0
<span class="gp">R6(config-if)#</span>ip address 172.16.106.106 255.255.255.255
<span class="gp">R6(config-if)#</span><span class="nb">exit</span>
</code></pre></div></div>
<p>Então na configuração anterior, colocamos o IP 172.16.106.106/32 (essa máscara é para identificar um <em>host</em>), na primeira interface de <em>loopback</em> (<code class="language-plaintext highlighter-rouge">lo0</code>).</p>

<p>Agora configuraremos o BGP, neste caso o R6 vamos conectar o R6 à R7 (172.16.107.107), e ao R8 (172.16.108.108):</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R6(config)#</span>no router bgp 3
<span class="gp">R6(config)#</span>router bgp 3
<span class="gp">R6(config-router)#</span>neighbor 172.16.107.107 remote-as 3
<span class="gp">R6(config-router)#</span>neighbor 172.16.107.107 update-source lo0
<span class="gp">R6(config-router)#</span>neighbor 172.16.107.107 next-hop-self
<span class="gp">R6(config-router)#</span>neighbor 172.16.108.108 remote-as 3
<span class="gp">R6(config-router)#</span>neighbor 172.16.108.108 update-source lo0
<span class="gp">R6(config-router)#</span>neighbor 172.15.108.108 next-hop-self
<span class="gp">R6(config-router)#</span>network 172.16.7.0 mask 255.255.255.0
<span class="gp">R6(config-router)#</span>network 172.16.8.0 mask 255.255.255.0
<span class="gp">R6(config-router)#</span>network 172.16.9.0 mask 255.255.255.0
<span class="gp">R6(config-router)#</span><span class="nb">exit</span>
</code></pre></div></div>
<p>Observe que para cada IP, como por exemplo do 172.16.107.107 do R7, temos três linhas de comando, sendo o final dessas:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">remote-as 3</code>, que indica o AS do vizinho, como é um iBGP, todos os vizinhos nessa configuração tem o mesmo número (<code class="language-plaintext highlighter-rouge">3</code>);</li>
  <li><code class="language-plaintext highlighter-rouge">update-source lo0</code>, informa que uma interface de <em>loopback</em> pode ser utilizada para criar conexões BGP.</li>
  <li><code class="language-plaintext highlighter-rouge">next-hop-self</code>, obriga o roteador iBGP repassar como sendo ele mesmo o roteador de próximo saldo de uma rota que ele aprendeu via eBGP, caso esse comando não seja utilizado, o roteador iBGP para como sendo o próximo salto, o roteador pelo qual ele aprendeu a rota, o que pode gerar (normalmente gera), inconsistências, já que muitas vezes o roteador não sabe chegar naquela rota.</li>
</ul>

<p>Também foram configuradas as redes a serem publicadas via BGP, tal como: <code class="language-plaintext highlighter-rouge">network 172.16.7.0 mask 255.255.255.0</code>.</p>

<p>Feitas as configurações anteriores, vamos configurar o RIP, para que esse propague as redes internas do AS3, principalmente os IPs que estamos utilizando nas interfaces de <em>loopback</em>, para que essas sejam conhecidas por todos os roteadores do AS3.</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R6(config)#</span>router rip
<span class="gp">R6(config-router)#</span>version 2
<span class="gp">R6(config-router)#</span>network 172.16.2.0
<span class="gp">R6(config-router)#</span>network 172.16.1.0
<span class="gp">R6(config-router)#</span>network 172.16.106.106
</code></pre></div></div>
<blockquote>
  <p>Lembrando que sem o RIP ou algo similar, os roteadores da rede não conseguiriam estabelecer a conexão BGP, pois não saberiam como se conectar aos roteadores, principalmente por causa do IP de utilizado na interface de <em>loopback</em>.</p>
</blockquote>

<blockquote>
  <p>Neste cenário só a título de ilustração estamos utilizando o RIP, mas poderia ser qualquer outro, como de preferência o OSPF e tal configuração também poderia ser feita via roteamento estático, já que a rede não é muito grande!</p>
</blockquote>

<p>Agora vamos basicamente repetir as mesmas configurações em R7 e R8, só alterando os IPs de vizinhos:</p>
<ul>
  <li>Roteador R7:</li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R7(config)#</span>interface lo0
<span class="gp">R7(config-if)#</span>ip address 172.16.107.107 255.255.255.255
<span class="gp">R7(config-if)#</span><span class="nb">exit</span>
<span class="go">
</span><span class="gp">R7(config)#</span>router bgp 3
<span class="gp">R7(config-router)#</span>neighbor 172.16.106.106 remote-as 3
<span class="gp">R7(config-router)#</span>neighbor 172.16.106.106 update-source lo0
<span class="gp">R7(config-router)#</span>neighbor 172.16.106.106 next-hop-self
<span class="gp">R7(config-router)#</span>neighbor 172.16.108.108 remote-as 3
<span class="gp">R7(config-router)#</span>neighbor 172.16.108.108 update-source lo0
<span class="gp">R7(config-router)#</span>neighbor 172.16.108.108 next-hop-self
<span class="gp">R7(config-router)#</span><span class="nb">exit</span>
<span class="go">
</span><span class="gp">R7(config)#</span>router rip
<span class="gp">R7(config-router)#</span>version 2
<span class="gp">R7(config-router)#</span>network 172.16.2.0
<span class="gp">R7(config-router)#</span>network 172.16.3.0
<span class="gp">R7(config-router)#</span>network 172.16.107.107
<span class="gp">R7(config-router)#</span><span class="nb">exit</span>
</code></pre></div></div>
<ul>
  <li>Roteador R8:</li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R8(config)#</span>interface lo0
<span class="gp">R8(config-if)#</span>ip address 172.16.108.108 255.255.255.255
<span class="gp">R8(config-if)#</span><span class="nb">exit</span>
<span class="go">
</span><span class="gp">R8(config)#</span>router bgp 3
<span class="gp">R8(config-router)#</span>neighbor 172.16.106.106 remote-as 3
<span class="gp">R8(config-router)#</span>neighbor 172.16.106.106 update-source lo0
<span class="gp">R8(config-router)#</span>neighbor 172.16.106.106 next-hop-self
<span class="gp">R8(config-router)#</span>neighbor 172.16.107.107 remote-as 3
<span class="gp">R8(config-router)#</span>neighbor 172.16.107.107 update-source lo0
<span class="gp">R8(config-router)#</span>neighbor 172.16.107.107 next-hop-self
<span class="gp">R8(config-router)#</span><span class="nb">exit</span>
<span class="go">
</span><span class="gp">R8(config)#</span>router rip
<span class="gp">R8(config-router)#</span>version 2
<span class="gp">R8(config-router)#</span>network 172.16.1.0
<span class="gp">R8(config-router)#</span>network 172.16.3.0
<span class="gp">R8(config-router)#</span>network 172.16.108.108
<span class="gp">R8(config-router)#</span><span class="nb">exit</span>
<span class="gp">R8(config)#</span>end
</code></pre></div></div>

<p>Feita as devidas configurações em R6, R7 e R8, vejamos se há conexão BGP entre eles, vamos fazer isso em R6:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R6#</span>show ip bgp summary
<span class="go">BGP router identifier 172.16.106.106, local AS number 3
</span><span class="c">...
</span><span class="go">Neighbor        V          AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
172.16.0.103    4          1    1417    1415       58    0    0 00:02:50        2
172.16.107.107  4          3    1363    1383       58    0    0 21:48:32        0
172.16.108.108  4          3    1366    1397       58    0    0 21:43:21        0
</span></code></pre></div></div>
<p>Na saída anterior é possível verificar que há uma conexão eBGP entre R6-&gt;R3 (172.16.0.103) - isso já funcionava, mas principalmente há conexão estabelecida (números inteiros na última coluna) com os IPs 172.16.107.107 e 172.16.108.108, que são respectivamente os IPs atrelados as interfaces de <em>loopback</em> de R7 e R8. Ou seja, conseguimos estabelecer conexão com os vizinhos iBGP utilizando os IPs criados só para isso.</p>

<p>Agora vamos ver se as rotas estão sendo propagadas corretamente, vamos fazer isso em R8:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R8#</span>show ip bgp
<span class="go">BGP table version is 116, local router ID is 172.16.108.108
</span><span class="gp">Status codes: s suppressed, d damped, h history, * valid, &gt;</span><span class="w"> </span>best, i - internal,
<span class="go">              r RIB-failure, S Stale
Origin codes: i - IGP, e - EGP, ? - incomplete

   Network          Next Hop            Metric LocPrf Weight Path
</span><span class="gp">*&gt;</span>i10.1.1.0/24      172.16.106.106           0    100      0 1 i
<span class="gp">*&gt;</span>i10.1.2.0/24      172.16.106.106           0    100      0 1 i
<span class="gp">r&gt;</span>i172.16.7.0/24    172.16.106.106           1    100      0 i
<span class="gp">r&gt;</span>i172.16.8.0/24    172.16.106.106           1    100      0 i
<span class="gp">r&gt;</span>i172.16.9.0/24    172.16.106.106           1    100      0 i
</code></pre></div></div>

<p>Segundo a saída anterior, com toda a configuração feita até agora, é possível acessar LAN1, LAN2, LAN7, LAN8 e LAN9. Sendo que LAN 1 e 2, são rotas fornecidas via eBGP, já LAN7, 8 e 9, são fornecidas via BGP, mas o R8 está utilizando o RIP para alcançar tais redes, essa informação é o <code class="language-plaintext highlighter-rouge">r</code>, que está na frente das rotas para LAN 7, 8, e 9. O <code class="language-plaintext highlighter-rouge">r</code> significa <em>RIB-failure</em>, que diz que há uma rota com mais prioridade, que não é o BGP.</p>

<blockquote>
  <p>Se você quiser ver em detalhes execute o comando <code class="language-plaintext highlighter-rouge">show ip route</code> e você verá que a rota para essas redes é fornecida via RIP e não BGP - a rota do BGP está lá, mas ela perde em prioridade para o RIP/IGP, que perde para uma rota estática (caso houvesse alguma).</p>
</blockquote>

<p>Vamos realizar um teste do conectividade do PC9 para as redes que são alcançadas até o momento (redes do AS3 e do R3):</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">PC9&gt;</span><span class="w"> </span>ping 172.16.7.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 172.16.7.1 icmp_seq=1 ttl=62 time=39.488 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 172.16.8.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 172.16.8.1 icmp_seq=1 ttl=62 time=33.870 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 10.1.1.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 10.1.1.1 icmp_seq=1 ttl=61 time=62.926 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 10.1.2.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 10.1.2.1 icmp_seq=1 ttl=61 time=69.650 ms
</span></code></pre></div></div>
<p>A saída mostra que todas as redes conectadas no AS3 e no R3, estão acessíveis com as técnicas/configurações que realizamos até agora. Entretanto, o leitor mais crítico, já deve estar a algum tempo se perguntando, quando é que os roteadores do AS1 vão propagar as redes BGP de todos os ASs para todos. Vamos fazer isso na sequência - deixamos para o final, pois o AS1 será o mais complexo do cenário do exemplo.</p>

<h2 id="configurando-ibgp-no-as-1">Configurando iBGP no AS 1</h2>

<p>Vamos configurar agora o AS1, que é um <em>backbone</em>, ou seja, ele conecta todas as redes do cenário. Bem, na verdade até agora o AS1 é uma rede bem desconexa, pois a maioria dos roteadores deste AS já sabem a respeito de outros ASs, mas eles não estão trocando informações entre os roteadores do próprio AS a respeito disso, logo a rede do cenário não se conecta por completo.</p>

<p>Para o AS1, vamos utilizar ainda as abordagens:</p>
<ul>
  <li>IP nas interfaces de <em>loopback</em>, para evitar que alguma interface física “caia” e o cenário fique parcialmente ou totalmente desconexo;</li>
  <li>OSPF para propagar localmente as redes do AS1, bem como os IPs atribuídos nas interfaces de <em>loopback</em> dos roteadores de AS1;</li>
  <li><strong>Route Reflector</strong> para trocar informações a respeito de rotas iBGP no AS1.</li>
</ul>

<p>Assim vamos inciar a configuração pelo R1, que será nosso Route Reflector:</p>
<ul>
  <li>R1:</li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R1#</span>configure terminal
<span class="gp">R1(config)#</span>interface lo0
<span class="gp">R1(config-if)#</span>ip address 10.1.101.101 255.255.255.255
<span class="gp">R1(config-if)#</span><span class="nb">exit</span>
<span class="go">
</span><span class="gp">R1(config)#</span>router bgp 1
<span class="gp">R1(config-router)#</span>neighbor 10.1.102.102 remote-as 1
<span class="gp">R1(config-router)#</span>neighbor 10.1.102.102 update-source lo0
<span class="gp">R1(config-router)#</span>neighbor 10.1.102.102 route-reflector-client
<span class="gp">R1(config-router)#</span>neighbor 10.1.102.102 next-hop-self
<span class="go">
</span><span class="gp">R1(config-router)#</span>neighbor 10.1.255.103 remote-as 1
<span class="gp">R1(config-router)#</span>neighbor 10.1.255.103 update-source lo0
<span class="gp">R1(config-router)#</span>neighbor 10.1.255.103 route-reflector-client
<span class="gp">R1(config-router)#</span>neighbor 10.1.255.103 next-hop-self
<span class="go">

</span><span class="gp">R1(config-router)#</span>neighbor 10.1.104.104 remote-as 1
<span class="gp">R1(config-router)#</span>neighbor 10.1.104.104 update-source lo0
<span class="gp">R1(config-router)#</span>neighbor 10.1.104.104 route-reflector-client
<span class="gp">R1(config-router)#</span>neighbor 10.1.104.104 next-hop-self
<span class="go">
</span><span class="gp">R1(config-router)#</span>network 10.1.1.0 mask 255.255.255.0
<span class="gp">R1(config-router)#</span>network 10.1.2.0 mask 255.255.255.0
<span class="gp">R1(config-router)#</span>network 10.1.3.0 mask 255.255.255.0
<span class="gp">R1(config-router)#</span>network 10.1.4.0 mask 255.255.255.0
<span class="gp">R1(config-router)#</span><span class="nb">exit</span>
<span class="go">
</span><span class="gp">R1(config)#</span>router ospf 1
<span class="gp">R1(config-router)#</span>network 10.1.100.0 0.0.0.255 area 0
<span class="gp">R1(config-router)#</span>network 10.1.103.0 0.0.0.255 area 0
<span class="gp">R1(config-router)#</span>network 10.1.101.101 0.0.0.0 area 0
<span class="gp">R1(config-router)#</span>passive-interface f0/0
<span class="gp">R1(config-router)#</span><span class="w">
</span></code></pre></div></div>

<p>Sendo o R1 o roteador escolhido para ser o <em>Route Reflector</em>, sua configuração naturalmente é a mais complexa dentre dos roteadores do AS1. Na saída anterior, configuramos em ordem (blocos)</p>
<ul>
  <li>A interface de <em>loopback</em> <code class="language-plaintext highlighter-rouge">lo0</code> com o IP 10.1.101.101/32;</li>
  <li>o R2 como vizinho, note que aqui foi necessário dizer que estamos utilizando a interface de <em>loopback</em> (<code class="language-plaintext highlighter-rouge">update-source</code>), dizemos que ele é um cliente do <em>Route Reflector</em> (<code class="language-plaintext highlighter-rouge">route-reflector-client</code>) e por fim que as rotas repassadas para ele devem ter R1 como roteador de próximo salto;</li>
  <li>Idem ao anterior com R3 - atenção note que o IP do R3 na interface de <em>loopback</em>, saiu fora do padrão utilizado, então muita atenção ao copiar esse cenário para informar o IP correto, que é 10.1.<strong>255</strong>.103;</li>
  <li>Idem ao R2 com o R4.</li>
  <li>Em penúltimo lugar foram configuradas as rede a serem anunciadas via BGP;</li>
  <li>Por fim o OSPF.</li>
</ul>

<p>Configurado o <em>Route Reflector</em>, vamos configurar os clientes:</p>

<ul>
  <li>R2:</li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R2#</span>configure terminal
<span class="go">Enter configuration commands, one per line.  End with CNTL/Z.
</span><span class="gp">R2(config)#</span>interface lo0
<span class="gp">R2(config-if)#</span>ip address 10.1.102.102 255.255.255.255
<span class="gp">R2(config-if)#</span><span class="nb">exit</span>
<span class="go">
</span><span class="gp">R2(config)#</span>router bgp 1
<span class="gp">R2(config-router)#</span>neighbor 10.1.101.101 remote-as 1
<span class="gp">R2(config-router)#</span>neighbor 10.1.101.101 update-source lo0
<span class="gp">R2(config-router)#</span>neighbor 10.1.101.101 next-hop-self
<span class="gp">R2(config-router)#</span><span class="nb">exit</span>
<span class="go">
</span><span class="gp">R2(config)#</span>router ospf 1
<span class="gp">R2(config-router)#</span>network 10.1.3.0 0.0.0.255 area 0
<span class="gp">R2(config-router)#</span>network 10.1.4.0 0.0.0.255 area 0
<span class="gp">R2(config-router)#</span>network 10.1.100.0 0.0.0.255 area 0
<span class="gp">R2(config-router)#</span>network 10.1.100.0 0.0.0.255 area 0
<span class="gp">R2(config-router)#</span>network 10.1.101.0 0.0.0.255 area 0
<span class="gp">R2(config-router)#</span>network 10.1.102.102 0.0.0.0 area 0
<span class="gp">R2(config-router)#</span>passive-interface g2/0
<span class="gp">R2(config-router)#</span>passive-interface g2/0
<span class="gp">R2(config-router)#</span>passive-interface g1/0
<span class="gp">R2(config-router)#</span>passive-interface f0/0
</code></pre></div></div>
<ul>
  <li>R3:</li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R3#</span>configure terminal
<span class="gp">R3(config)#</span>interface lo0
<span class="gp">R3(config-if)#</span>ip address 10.1.255.103 255.255.255.255
<span class="gp">R3(config-if)#</span><span class="nb">exit</span>
<span class="go">
</span><span class="gp">R3(config)#</span>router bgp 1
<span class="gp">R3(config-router)#</span>neighbor 10.1.101.101 remote-as 1
<span class="gp">R3(config-router)#</span>neighbor 10.1.101.101 update-source lo0
<span class="gp">R3(config-router)#</span>neighbor 10.1.101.101 next-hop-self
<span class="gp">R3(config-router)#</span><span class="nb">exit</span>
<span class="go">
</span><span class="gp">R3(config)#</span>router ospf 1
<span class="gp">R3(config-router)#</span>network 10.1.103.0 0.0.0.255 area 0
<span class="gp">R3(config-router)#</span>network 10.1.102.0 0.0.0.255 area 0
<span class="gp">R3(config-router)#</span>network 10.1.1.0 0.0.0.255 area 0
<span class="gp">R3(config-router)#</span>network 10.1.2.0 0.0.0.255 area 0
<span class="gp">R3(config-router)#</span>network 10.1.255.103 0.0.0.0 area 0
<span class="gp">R3(config-router)#</span>passive-interface f0/0
<span class="gp">R3(config-router)#</span>passive-interface g1/0
<span class="gp">R3(config-router)#</span>passive-interface g4/0
</code></pre></div></div>
<ul>
  <li>R4:</li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R4(config)#</span>interface lo0
<span class="gp">R4(config-if)#</span>ip address 10.
<span class="gp">R4(config-if)#</span>ip address 10.1.104.104 255.255.255.255
<span class="gp">R4(config-if)#</span><span class="nb">exit</span>
<span class="go">
</span><span class="gp">R4(config)#</span>router bgp 1
<span class="gp">R4(config-router)#</span>neighbor 10.1.101.101 remote-as 1
<span class="gp">R4(config-router)#</span>neighbor 10.1.101.101 update-source lo0
<span class="gp">R4(config-router)#</span>neighbor 10.1.101.101 next-hop-self
<span class="gp">R4(config-router)#</span><span class="nb">exit</span>
<span class="go">
</span><span class="gp">R4(config)#</span>router ospf 1
<span class="gp">R4(config-router)#</span>network 10.1.101.0 0.0.0.255 area 0
<span class="gp">R4(config-router)#</span>network 10.1.101.0 0.0.0.255 area 0
<span class="gp">R4(config-router)#</span>network 10.1.102.0 0.0.0.255 area 0
<span class="gp">R4(config-router)#</span>network 10.1.104.104 0.0.0.0 area 0
</code></pre></div></div>

<p>As configurações de todos os clientes R2, R3 e R4 são muito similares, só trocando os IPs para se adequarem à cada roteador, a configuração em ordem é: que o roteador em questão é vizinho de R1, que vai utilizar a interface de <em>loopback</em> e configura o OSPF.</p>

<blockquote>
  <p>Foi executado o comando <code class="language-plaintext highlighter-rouge">passive-interface</code> no OSPF para garantir que não há comunicação BGP entre o AS1 e os demais, principalmente o AS4 que também utiliza OSPF.</p>
</blockquote>

<p>Após executar corretamente tais comandos em seus respectivos roteadores vamos verificar se há vizinhança entre eles, mais especificamente vamos observar se há vizinhança entre R4 e R1, pois sem o iBGP, <em>loopback</em> e o OSPF configurado corretamente, o R4 não se conectaria de forma alguma ao R1, pois eles não são vizinhos físicos:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R4#</span>show ip bgp summary
<span class="go">BGP router identifier 10.1.104.104, local AS number 1
</span><span class="c">...
</span><span class="go">Neighbor        V          AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
10.1.101.101    4          1      20      15       23    0    0 00:12:59       12
</span></code></pre></div></div>

<p>Com a saída anterior, é possível constatar que foi estabelecida a conexão TCP/179, ou seja, BGP entre R4 e R1 (10.1.101.101), e tal conexão está no estado Established (última coluna com o número inteiro positivo). Ou seja, a configuração iBGP, o <em>loopback</em> e o OSPF foram configurados de acordo com o esperado.</p>

<p>Visto isso, vamos verificar a tabela de roteamento do R4:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R4#</span>show ip bgp
<span class="go">BGP table version is 23, local router ID is 10.1.104.104
</span><span class="gp">Status codes: s suppressed, d damped, h history, * valid, &gt;</span><span class="w"> </span>best, i - internal,
<span class="go">              r RIB-failure, S Stale
Origin codes: i - IGP, e - EGP, ? - incomplete

   Network          Next Hop            Metric LocPrf Weight Path
</span><span class="gp">r&gt;</span>i10.1.1.0/24      10.1.101.101             2    100      0 i
<span class="gp">r&gt;</span>i10.1.2.0/24      10.1.101.101             2    100      0 i
<span class="gp">r&gt;</span>i10.1.3.0/24      10.1.101.101             2    100      0 i
<span class="gp">r&gt;</span>i10.1.4.0/24      10.1.101.101             2    100      0 i
<span class="gp">*&gt;</span>i10.2.5.0/24      10.1.101.101             0    100      0 2 i
<span class="gp">*&gt;</span>i10.2.6.0/24      10.1.101.101             0    100      0 2 i
<span class="gp">*&gt;</span>i172.16.7.0/24    10.1.255.103             1    100      0 3 i
<span class="gp">*&gt;</span>i172.16.8.0/24    10.1.255.103             1    100      0 3 i
<span class="gp">*&gt;</span>i172.16.9.0/24    10.1.255.103             1    100      0 3 i
<span class="gp">*&gt;</span>i192.168.10.0     10.1.102.102             2    100      0 4 i
<span class="gp">*&gt;</span>i192.168.11.0     10.1.102.102             2    100      0 4 i
<span class="gp">*&gt;</span>i192.168.12.0     10.1.102.102             2    100      0 4 i
</code></pre></div></div>

<p>Como pode ser visto na saída anterior, o R4 tem rotas para todas as redes anunciadas via BGP no cenário: LAN 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11 e 12. Isso significa que há integração entre todos os ASs do cenário de rede, o que é ótimo! :-D</p>

<p>Vamos verificar se essas rotas também foram propagadas para o R8 do AS3, que é um iBGP deste cenário:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R8#</span>show ip bgp
<span class="go">BGP table version is 123, local router ID is 172.16.108.108
</span><span class="gp">Status codes: s suppressed, d damped, h history, * valid, &gt;</span><span class="w"> </span>best, i - internal,
<span class="go">              r RIB-failure, S Stale
Origin codes: i - IGP, e - EGP, ? - incomplete

   Network          Next Hop            Metric LocPrf Weight Path
</span><span class="gp">*&gt;</span>i10.1.1.0/24      172.16.106.106           0    100      0 1 i
<span class="gp">*&gt;</span>i10.1.2.0/24      172.16.106.106           0    100      0 1 i
<span class="gp">*&gt;</span>i10.1.3.0/24      172.16.106.106           0    100      0 1 i
<span class="gp">*&gt;</span>i10.1.4.0/24      172.16.106.106           0    100      0 1 i
<span class="gp">*&gt;</span>i10.2.5.0/24      172.16.106.106           0    100      0 1 2 i
<span class="gp">*&gt;</span>i10.2.6.0/24      172.16.106.106           0    100      0 1 2 i
<span class="gp">r&gt;</span>i172.16.7.0/24    172.16.106.106           1    100      0 i
<span class="gp">r&gt;</span>i172.16.8.0/24    172.16.106.106           1    100      0 i
<span class="gp">r&gt;</span>i172.16.9.0/24    172.16.106.106           1    100      0 i
<span class="gp">*&gt;</span>i192.168.10.0     172.16.106.106           0    100      0 1 4 i
<span class="gp">*&gt;</span>i192.168.11.0     172.16.106.106           0    100      0 1 4 i
<span class="gp">*&gt;</span>i192.168.12.0     172.16.106.106           0    100      0 1 4 i
</code></pre></div></div>

<p>Bem o resultado é o mesmo do obtido anteriormente, ou seja, o roteador possui rotas para todas as redes…</p>

<p>Assim, vamos realizar testes de conectividade e redundância para ver o comportamento das configurações BGP.</p>

<h2 id="teste-de-conectividade-do-cenário">Teste de conectividade do cenário</h2>

<p>Para finalizar o teste vamos, executar o <code class="language-plaintext highlighter-rouge">ping</code> do PC9, conectado ao R8 para todos os outros PCs/redes do cenário proposto:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">PC9&gt;</span><span class="w"> </span>ping 10.1.1.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 10.1.1.1 icmp_seq=1 ttl=61 time=34.343 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 10.1.2.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 10.1.2.1 icmp_seq=1 ttl=61 time=46.063 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 10.1.3.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 10.1.3.1 icmp_seq=1 ttl=59 time=72.621 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 10.1.4.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 10.1.4.1 icmp_seq=1 ttl=59 time=99.155 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 10.2.5.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 10.2.5.1 icmp_seq=1 ttl=59 time=62.595 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 10.2.6.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 10.2.6.1 icmp_seq=1 ttl=59 time=65.700 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 172.16.7.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 172.16.7.1 icmp_seq=1 ttl=62 time=33.468 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 172.16.8.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 172.16.8.1 icmp_seq=1 ttl=62 time=31.527 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 192.168.10.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 192.168.10.1 icmp_seq=1 ttl=57 time=97.777 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 192.168.11.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 192.168.11.1 icmp_seq=1 ttl=57 time=82.784 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 192.168.12.1 <span class="nt">-c</span> 1
<span class="go">84 bytes from 192.168.12.1 icmp_seq=1 ttl=57 time=91.569 ms
</span></code></pre></div></div>

<p>Assim, as saídas dos “<em>pings</em>” realizados, demonstram também que o cenário está totalmente funcional e conectado.</p>

<h2 id="teste-redundância">Teste redundância</h2>

<p>Para o teste de redundância vamos verificar primeiro qual é o caminho percorrido para levar pacotes de rede do PC9 do AS3 para o PC10 do AS4:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">PC9&gt;</span><span class="w"> </span>trace 192.168.10.1
<span class="go">trace to 192.168.10.1, 8 hops max, press Ctrl+C to stop
 1   172.16.9.108   9.759 ms  9.260 ms  9.843 ms
 2   172.16.1.106   29.475 ms  29.890 ms  29.384 ms
 3   172.16.0.103   40.609 ms  40.308 ms  39.760 ms
 4   10.1.102.104   49.619 ms  49.643 ms  49.690 ms
 5   10.1.101.102   59.860 ms  60.223 ms  49.514 ms
 6   192.168.0.109   69.848 ms  70.064 ms  69.924 ms
 7   192.168.1.110   80.264 ms  80.449 ms  79.656 ms
 8   *192.168.10.1   100.543 ms (ICMP type:3, code:3, Destination port unreachable)

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 192.168.10.1
<span class="go">
84 bytes from 192.168.10.1 icmp_seq=1 ttl=57 time=90.143 ms
</span></code></pre></div></div>
<p>Para os pacotes saírem no PC9 para o PC10, eles passam pelos seguinte roteadores: R8, R6, R3, R4, R2, R9 e R10. Visto isso vamos desligar as conexões de rede (os <em>links</em>) entre R8-R6 e R3-R4, que são caminhos escolhidos pelo BGP para enviar os pacotes do PC9 para o PC10. Veja como fica o cenário na Figura 3 (veja os <em>links</em> em amarelo com um o sinal de “<em>pause</em>”).</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="imagens/BGP03-pause.png" alt="rede" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">Figura 3 - Teste de redundância</td>
    </tr>
  </tbody>
</table>

<p>No teste o R3, demorou quase 2 minutos para trocar a rota para o AS4 do R4 para o R1. Já o R8 demorou mais que 2 minutos para perceber a mudança. Todavia, as redes convergiram para um novo caminho que leve ao destino, veja a nova rota:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">PC9&gt;</span><span class="w"> </span>trace 192.168.10.1
<span class="go">trace to 192.168.10.1, 8 hops max, press Ctrl+C to stop
 1   172.16.9.108   9.152 ms  9.724 ms  9.226 ms
 2   172.16.3.107   19.728 ms  19.474 ms  19.323 ms
 3   172.16.2.106   39.356 ms  40.118 ms  39.730 ms
 4   172.16.0.103   60.384 ms  59.970 ms  50.196 ms
 5   10.1.103.101   80.017 ms  80.280 ms  69.667 ms
 6   10.1.100.102   90.016 ms  90.387 ms  89.740 ms
 7   192.168.0.109   110.100 ms  110.196 ms  109.826 ms
 8   192.168.1.110   129.752 ms  120.027 ms  120.573 ms

</span><span class="gp">PC9&gt;</span><span class="w"> </span>ping 192.168.10.1
<span class="go">
84 bytes from 192.168.10.1 icmp_seq=1 ttl=56 time=95.506 ms
</span></code></pre></div></div>
<p>Agora a nova rota de PC9 para PC10 é: R8, R7, R6, R3, R1, R2, R9 e R10.</p>

<p><strong>Atenção</strong>: é sempre bom realizar testes de redundância em uma rede BGP, pois uma configuração pode funcionar em um cenário de rede, que quando alterado, a rede inteira ou parte dela pode parar de funcionar. Então, após configurar uma rede BGP, tente ligar/desligar todos os possíveis pontos da rede e verificar se ainda há conectividade.</p>

<p>Lembrando que no AS1 há um grande ponto de falha, que é o R1, então caso este roteador pare, a comunicação entre os ASs vão parar também, para que isso não ocorra seria possível alguma abordagem como um roteador <em>backup</em> ou um <em>cluster</em>.</p>

<h2 id="agregação-de-rotas">Agregação de rotas</h2>

<p>Nosso cenário de exemplo é grande, mas nem se compara com a Internet, mesmo assim note que a tabela de roteamento BGP já ficou relativamente grande, o que pode consumir muito processamento na análise de rotas, bem como memória para armazenar tais rotas, ou mesmo, pode tornar a análise pelos seres humanos mais confusa (ruim de analisar). Para amenizar esse problema é possível agregar as rotas, ou seja, juntar em uma mesma rota, endereços IPs muito similares.</p>

<p>No nosso exemplo de rede, há pelo menos três redes que podemos agregar, que são as redes do AS2, AS3 e AS4. Assim, vamos agregar essas redes para ilustrar a técnica de agregação de rotas, vamos iniciar pelo AS3:</p>
<ul>
  <li>R6 no AS3:</li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R6#</span>configure terminal
<span class="go">Enter configuration commands, one per line.  End with CNTL/Z.
</span><span class="gp">R6(config)#</span>router bgp 3
<span class="gp">R6(config-router)#</span>aggregate-address 172.16.0.0 255.255.0.0 summary-only
</code></pre></div></div>

<p>O roteador R6, no AS3 é quem publica as rede, então executamos o comando <code class="language-plaintext highlighter-rouge">aggregate-address</code> dizendo para ao invés de anunciar as redes 172.16.7.0/24, 172.16.7.0/24 e 172.16.7.0/24, que essas fossem anunciadas como a rede 172.16.0.0/16. Ou seja, a ideia é que os roteadores vão ter agora apenas uma entrada em sua tabela de roteamento, que é para a rede 172.16.0.0/16, e quando alguém quiser alguma sub-rede ou <em>host</em> dessa rede, deve seguir para o AS3, e chegando ao R6. Então, tal roteador consegue encaminhar corretamente os pacotes, por exemplo, os pacotes destinados a 172.16.7.0 deve ir para o R7 e os destinados à 172.16.9.0, devem ir para R8.</p>

<p>Vamos ver como era a tabela BGP do R1 antes e depois da agregação de endereços:</p>
<ul>
  <li>Tabela roteamento BGP antes:</li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R1#</span>show ip bgp
<span class="go">BGP table version is 20, local router ID is 10.2.0.101
   Network          Next Hop            Metric LocPrf Weight Path
* i10.1.1.0/24      10.1.255.103             0    100      0 i
</span><span class="gp">*&gt;</span><span class="w">                  </span>10.1.103.103             2         32768 i
<span class="go">* i10.1.2.0/24      10.1.255.103             0    100      0 i
</span><span class="gp">*&gt;</span><span class="w">                  </span>10.1.103.103             2         32768 i
<span class="gp">*&gt;</span><span class="w"> </span>10.1.3.0/24      10.1.100.102             2         32768 i
<span class="go">* i                 10.1.102.102             0    100      0 i
</span><span class="gp">*&gt;</span><span class="w"> </span>10.1.4.0/24      10.1.100.102             2         32768 i
<span class="go">* i                 10.1.102.102             0    100      0 i
</span><span class="gp">*&gt;</span><span class="w"> </span>10.2.5.0/24      10.2.0.105               0             0 2 i
<span class="gp">*&gt;</span><span class="w"> </span>10.2.6.0/24      10.2.0.105               0             0 2 i
<span class="gp">*&gt;</span>i172.16.7.0/24    10.1.255.103             1    100      0 3 i
<span class="gp">*&gt;</span>i172.16.8.0/24    10.1.255.103             1    100      0 3 i
<span class="gp">*&gt;</span>i172.16.9.0/24    10.1.255.103             1    100      0 3 i
<span class="gp">*&gt;</span>i192.168.10.0     10.1.102.102             2    100      0 4 i
<span class="gp">*&gt;</span>i192.168.11.0     10.1.102.102             2    100      0 4 i
<span class="gp">*&gt;</span>i192.168.12.0     10.1.102.102             2    100      0 4 i
</code></pre></div></div>

<ul>
  <li>Tabela roteamento BGP depois:</li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R1#</span>show ip bgp
<span class="go">   Network          Next Hop            Metric LocPrf Weight Path
* i10.1.1.0/24      10.1.255.103             0    100      0 i
</span><span class="gp">*&gt;</span><span class="w">                  </span>10.1.103.103             2         32768 i
<span class="go">* i10.1.2.0/24      10.1.255.103             0    100      0 i
</span><span class="gp">*&gt;</span><span class="w">                  </span>10.1.103.103             2         32768 i
<span class="gp">*&gt;</span><span class="w"> </span>10.1.3.0/24      10.1.100.102             2         32768 i
<span class="go">* i                 10.1.102.102             0    100      0 i
</span><span class="gp">*&gt;</span><span class="w"> </span>10.1.4.0/24      10.1.100.102             2         32768 i
<span class="go">* i                 10.1.102.102             0    100      0 i
</span><span class="gp">*&gt;</span><span class="w"> </span>10.2.5.0/24      10.2.0.105               0             0 2 i
<span class="gp">*&gt;</span><span class="w"> </span>10.2.6.0/24      10.2.0.105               0             0 2 i
<span class="gp">*&gt;</span>i172.16.0.0       10.1.255.103             0    100      0 3 i
<span class="gp">*&gt;</span>i192.168.10.0     10.1.102.102             2    100      0 4 i
<span class="gp">*&gt;</span>i192.168.11.0     10.1.102.102             2    100      0 4 i
<span class="gp">*&gt;</span>i192.168.12.0     10.1.102.102             2    100      0 4 i
</code></pre></div></div>

<p>Comparando as saídas anteriores, é possível notar que agora todas as redes do AS3 se resumem em: 172.16.0.0.</p>

<p>Vamos realizar o mesmo processo no R9 do AS4 e no R5 do AS2:</p>
<ul>
  <li>R9</li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R9(config)#</span>router bgp 4
<span class="gp">R9(config-router)#</span>aggregate-address 192.168.0.0 255.255.0.0 summary-only
<span class="gp">R9(config-router)#</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>R5</li>
</ul>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R5(config-router)#</span>router bgp 2
<span class="gp">R5(config-router)#</span>aggregate-address 10.2.0.0 255.255.0.0 summary-only
</code></pre></div></div>

<p>Feito isso, vamos ver como ficou a tabela de rotas BGP do R1:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">R1#</span>show ip bgp
<span class="go">BGP table version is 31, local router ID is 10.2.0.101
</span><span class="gp">Status codes: s suppressed, d damped, h history, * valid, &gt;</span><span class="w"> </span>best, i - internal,
<span class="go">              r RIB-failure, S Stale
Origin codes: i - IGP, e - EGP, ? - incomplete

   Network          Next Hop            Metric LocPrf Weight Path
* i10.1.1.0/24      10.1.255.103             0    100      0 i
</span><span class="gp">*&gt;</span><span class="w">                  </span>10.1.103.103             2         32768 i
<span class="go">* i10.1.2.0/24      10.1.255.103             0    100      0 i
</span><span class="gp">*&gt;</span><span class="w">                  </span>10.1.103.103             2         32768 i
<span class="gp">*&gt;</span><span class="w"> </span>10.1.3.0/24      10.1.100.102             2         32768 i
<span class="go">* i                 10.1.102.102             0    100      0 i
</span><span class="gp">*&gt;</span><span class="w"> </span>10.1.4.0/24      10.1.100.102             2         32768 i
<span class="go">* i                 10.1.102.102             0    100      0 i
</span><span class="gp">*&gt;</span><span class="w"> </span>10.2.0.0/16      10.2.0.105               0             0 2 i
<span class="gp">*&gt;</span>i172.16.0.0       10.1.255.103             0    100      0 3 i
<span class="gp">*&gt;</span>i192.168.0.0/16   10.1.102.102             0    100      0 4 i
</code></pre></div></div>

<p>Dada a saída anterior, se comparada com a primeira saída do R1 nesta seção, é possível constatar que ficaram menos entradas na tabela BGP. No caso, ficaram apenas entradas para as redes internas (LAN1, LAN 2, LAN3  e LAN4) e agregações que basicamente estão simbolizando tudo o que há dentro de cada AS, ou seja:</p>
<ul>
  <li>AS2 - 10.2.0.0/16</li>
  <li>AS3 - 172.16.0.0/16</li>
  <li>AS4 - 192.168.0.0/24</li>
</ul>

<p>Desta forma, nesta rede, deduz-se que tudo que for 192.168. deve ir para o AS4, já se for 172.16. irá para o AS3, e se for 10.2. vai para o AS2.</p>

<p>Tal exemplo, demonstra que o a agregação ajuda a melhorar a leitura e processamento das rotas em redes BGP. Isso ajuda muito no entendimento de redes gigantes como à Internet. É claro que para utilizar a agregação de rotas, é necessário antes de tudo, projetar as redes para que essas permitam a utilização da agregação de rotas.</p>

<h1 id="conclusão">Conclusão</h1>

<p>O BGP é o protocolo de roteamento que interconecta a cocha de retalhos que é a Internet. Todavia ao contrário dos IGPs, o BGP não trata os problemas de forma automática, ou seja, o BGP depende muito do conhecimento do engenheiro de rede que vai configurá-lo, esse deve conhecer bem a fundo as vantagens e desvantagens do BGP e saber utilizar corretamente outras ferramentas que podem auxiliar a configuração do BGP (roteamento estático, IGPs, etc). Também há outros artifícios/ferramentas do próprio BGP que ajudam em sua configuração, mas não é intenção deste material cobrir tudo que há sobre BGP.</p>

<h1 id="arquivos-de-configurações-dos-roteadores-do-cenário">Arquivos de configurações dos roteadores do cenário</h1>

<p>Todos os arquivos de configurações do cenário estão nos <em>links</em> a seguir:</p>
<ul>
  <li><a href="confs/iBGP/R1.cfg">R1</a>, <a href="confs/iBGP/R2.cfg">R2</a>, <a href="confs/iBGP/R3.cfg">R3</a>, <a href="confs/iBGP/R4.cfg">R4</a>, <a href="confs/iBGP/R5.cfg">R5</a>, <a href="confs/iBGP/R6.cfg">R6</a>, <a href="confs/iBGP/R7.cfg">R7</a>, <a href="confs/iBGP/R8.cfg">R8</a>, <a href="confs/iBGP/R9.cfg">R9</a>, <a href="confs/iBGP/R10.cfg">R10</a> e <a href="confs/iBGP/R11.cfg">R11</a>.</li>
</ul>

<h1 id="referências">Referências</h1>

<ul>
  <li>
    <p><a href="https://www.catchpoint.com/bgp-monitoring/bgp-route-reflector">https://www.catchpoint.com/bgp-monitoring/bgp-route-reflector</a></p>
  </li>
  <li>
    <p><a href="https://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/13751-23.html">https://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/13751-23.html</a></p>
  </li>
</ul>

</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://creativecommons.org/licenses/by-nc/3.0/deed.en_US">
    <span>
        <b>Luiz Arthur Feitosa dos Santos</b>
    </span>
    
    <span>© 2024</span>
  </a>
</footer>


</body>

</html>
